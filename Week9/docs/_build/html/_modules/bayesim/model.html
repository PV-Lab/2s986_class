<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>bayesim.model &#8212; bayesim 0.9.1 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-2.3.2/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>

        <a class="brand" href="../../index.html">
          bayesim</a>
        <span class="navbar-text pull-left"><b></b></span>

        <div class="nav-collapse">
          <ul class="nav">
            <li class="divider-vertical"></li>
            
                <li><a href="../../genindex.html">Index</a></li>
                <li><a href="https://github.com/pv-lab/bayesim">Github</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whybayesim.html">Why bayesim?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bayesics.html">Technical Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../manual.html">Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../citingbayesim.html">Citing bayesim</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
      </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="span12 content">
      
  <h1>Source code for bayesim.model</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">bayesim.pmf</span> <span class="k">import</span> <span class="n">Pmf</span>
<span class="kn">import</span> <span class="nn">bayesim.params</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">from</span> <span class="nn">bayesim.utils</span> <span class="k">import</span> <span class="n">calc_deltas</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">deepdish</span> <span class="k">as</span> <span class="nn">dd</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="k">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span><span class="p">,</span> <span class="n">cpu_count</span>
<span class="kn">import</span> <span class="nn">time</span>

<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The main workhorse class of bayesim. Stores the modeled and observed data as well as a Pmf object which maintains the current probability distribution and grid subdivisions.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    [update this]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize with a uniform PMF over the fitting parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            obs_data_path (`str`): path to HDF5 file containing measured data</span>
<span class="sd">            load_state (`bool`): flag for whether to load state from a file - if True, other inputs (apart from state_file) are ignored</span>
<span class="sd">            state_file (`str`): path to file saved by save_state() fcn</span>
<span class="sd">            verbose (`bool`): flag for verbosity, defaults to False</span>
<span class="sd">            output_var (`str`): name of experimental output measurements</span>
<span class="sd">            params (:obj:`param_list`): Param_list object containing parameters to be fit and associated metadata</span>
<span class="sd">            ec_x_var (`str`): EC to plot on x-axis and consider in trimming data</span>
<span class="sd">            ec_list (:obj:`list` of :obj:`str`): names of experimental conditions</span>
<span class="sd">            ec_tols (`dict`): dict of form {ec_name_1:tolerance_1, ec_name_2:tolerance_2, ...}, will supersede ec_list</span>
<span class="sd">            ec_units (`dict`): dict of form {ec_name_1:units_1, ec_name_2:units_2, ...}, optional</span>
<span class="sd">            model_data_path (`str`): path to HDF5 file containing modeled data</span>
<span class="sd">            model_data_func (callable): handle to function for computing model data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">state_file</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state_file&#39;</span><span class="p">,</span> <span class="s1">&#39;bayesim_state.h5&#39;</span><span class="p">)</span>
        <span class="n">load_state</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;load_state&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">load_state</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading bayesim state from </span><span class="si">%s</span><span class="s1">...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">state_file</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">state_file</span><span class="p">)</span>

            <span class="c1"># variables</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ec_pts</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;ec_pts&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_var</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;output_var&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Param_list</span><span class="p">(</span><span class="n">param_dict</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>

            <span class="c1"># probabilities</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">prob_dict</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;probs&#39;</span><span class="p">])</span>

            <span class="c1"># model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;model_data&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_data_grps</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;model_data_grps&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_data_ecgrps</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;model_data_ecgrps&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">needs_new_model_data</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;needs_new_model_data&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;obs_data&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_run</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;is_run&#39;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Constructing bayesim model object...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># initialize empty parameter list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Param_list</span><span class="p">()</span>

            <span class="c1"># if a param_list object has been provided, attach it</span>
            <span class="k">if</span> <span class="s1">&#39;params&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attach_params</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">()</span>

            <span class="c1"># check if output list is populated / attach output variable</span>
            <span class="n">output_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># outputs are populated</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;output_var&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">output_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">argv</span><span class="p">[</span><span class="s1">&#39;output_var&#39;</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;It seems you are trying to add more than one output variable. Sorry, the current version of bayesim supports only one type of output - this will be addressed in future versions!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_var</span> <span class="o">=</span> <span class="n">output_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="c1"># for now</span>
            <span class="k">elif</span> <span class="s1">&#39;output_var&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add_output</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">argv</span><span class="p">[</span><span class="s1">&#39;output_var&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_var</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;output_var&#39;</span><span class="p">]</span> <span class="c1"># for now...eventually need to be general to multiple potential outputs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to define your output variable!&quot;</span><span class="p">)</span>

            <span class="c1"># attach EC&#39;s if provided explicitly, or infer from obs_data</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;ec_list&#39;</span><span class="p">,</span><span class="s1">&#39;ec_tols&#39;</span><span class="p">,</span><span class="s1">&#39;ec_units&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attach_ecs</span><span class="p">(</span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>

            <span class="c1"># set x-axis EC variable</span>
            <span class="k">if</span> <span class="s1">&#39;ec_x_var&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">set_ec_x</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="s1">&#39;ec_x_var&#39;</span><span class="p">])</span>

            <span class="c1"># attach observed data if provided</span>
            <span class="k">if</span> <span class="s1">&#39;obs_data_path&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attach_observations</span><span class="p">(</span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ec_pts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>

            <span class="c1"># attach modeled data if provided</span>
            <span class="k">if</span> <span class="s1">&#39;model_data_path&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attach_model</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;model_data_func&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attach_model</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_data_grps</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_data_ecgrps</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">needs_new_model_data</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># run flag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_run</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Model.attach_params"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.attach_params">[docs]</a>    <span class="k">def</span> <span class="nf">attach_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attach a param_list object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Overwriting preexiting parameter list with this new one.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.attach_ecs"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.attach_ecs">[docs]</a>    <span class="k">def</span> <span class="nf">attach_ecs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define parameters for experimental conditions.</span>

<span class="sd">        Args:</span>
<span class="sd">            ec_list (:obj:`list` of :obj:`str`): names of experimental conditions</span>
<span class="sd">            ec_tols (`dict`): dict of form {ec_name_1:tolerance_1, ec_name_2:tolerance_2, ...}, will supersede ec_list</span>
<span class="sd">            ec_units (`dict`): dict of form {ec_name_1:units_1, ec_name_2:units_2, ...}, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ec_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tol_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">unit_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;ec_tols&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">tol_dict</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;ec_tols&#39;</span><span class="p">]</span>
            <span class="n">ec_names</span> <span class="o">=</span> <span class="n">tol_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;ec_units&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">unit_dict</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;ec_units&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ec_names</span><span class="o">==</span><span class="p">[]:</span>
                <span class="n">ec_names</span> <span class="o">=</span> <span class="n">unit_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;ec_list&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ec_names</span><span class="o">==</span><span class="p">[]:</span>
                <span class="n">ec_names</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;ec_list&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ec_names</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">name</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tol_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;tolerance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tol_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">unit_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add_ec</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.attach_fit_params"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.attach_fit_params">[docs]</a>    <span class="k">def</span> <span class="nf">attach_fit_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attach list of parameters to fit.</span>

<span class="sd">        Args:</span>
<span class="sd">            param_list: list of Fit_param objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add_fit_param</span><span class="p">(</span><span class="n">param</span><span class="o">=</span><span class="n">param</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.attach_observations"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.attach_observations">[docs]</a>    <span class="k">def</span> <span class="nf">attach_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attach measured dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            obs_data_path (`str`): path to HDF5 file containing observed data</span>
<span class="sd">            keep_all (`bool`): whether to keep all the data in the file (longer simulation times) or to clip out data points that are close to each other (defaults to False)</span>
<span class="sd">            ec_x_var (`str`): required if keep_all is False, the experimental condition over which to measure differences (e.g. V for JV(Ti) curves in PV). It will also be used in plotting later.</span>
<span class="sd">            max_ec_x_step (`float`): used if keep_all is False, largest step to take in the ec_x_var before keeping a point even if curve if &quot;flat&quot; (defaults to 0.05 * range of ec_x_var)</span>
<span class="sd">            thresh_dif_frac (`float`): used if keep_all is False, threshold (as a percentage of the maximum value, defaults to 0.03)</span>
<span class="sd">            fixed_unc (`float`): required if running in function mode or if file doesn&#39;t have an &#39;uncertainty&#39; column, value to use as uncertainty in measurement</span>
<span class="sd">            output_column (`str`): optional, header of column containing output data (required if different from self.output_var)</span>
<span class="sd">            verbose (`bool`): flag for verbosity, defaults to False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_col</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_column&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">)</span>
        <span class="n">keep_all</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep_all&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">thresh_dif_frac</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thresh_dif_frac&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;ec_x_var&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">set_ec_x</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="s1">&#39;ec_x_var&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">keep_all</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;You must specify ec_x_var if you want to throw out data points that are too close together.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Attaching measured data...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="s1">&#39;obs_data_path&#39;</span><span class="p">])</span>
        <span class="c1"># get EC names if necessary</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Your output variable name, </span><span class="si">%s</span><span class="s1">, is not the name of a column in your input data!&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">output_col</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="s1">&#39;fixed_unc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;uncertainty&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;You need to either provide a value for fixed_unc or your measurement data needs to have an uncertainty column!&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output_col</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ecs</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;ec_x_var&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ecs</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Determining experimental conditions from observed data...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">==</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">:</span>
                        <span class="c1"># 1% of the smallest difference between values</span>
                        <span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="p">[</span><span class="n">c</span><span class="p">])))))</span>
                        <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="n">argv</span><span class="p">[</span><span class="s1">&#39;ec_x_var&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">set_tolerance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add_ec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Identified experimental conditions as </span><span class="si">%s</span><span class="s1">. (If this is wrong, rerun and explicitly specify them with attach_ec (make sure they match data file columns) or remove extra columns from data file.)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">param_names</span><span class="p">(</span><span class="s1">&#39;ec&#39;</span><span class="p">))))</span>

            <span class="c1"># these next bits used to be under an else...</span>
            <span class="k">if</span> <span class="s1">&#39;uncertainty&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;fixed_unc&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="p">))</span>
                <span class="n">cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">)</span>
                <span class="c1">#print(self.obs_data.head())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">set_tolerance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">,</span> <span class="mf">0.01</span><span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="s1">&#39;fixed_unc&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># set tolerance to 1% of minimum uncertainty</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">set_tolerance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">,</span> <span class="mf">0.01</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]))</span>

            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">()</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]):</span>
                <span class="k">pass</span> <span class="c1"># all good</span>
            <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">()</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ignoring extra columns in data file: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">())))))</span>
            <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">()</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;These experimental conditions were missing from your data file: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Proceeding assuming that </span><span class="si">%s</span><span class="s1"> is the full set of experimental conditions...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ec</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">))),</span> <span class="nb">str</span><span class="p">(</span><span class="n">cols</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">==</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add_ec</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="c1"># ...else ended here</span>

        <span class="c1"># pick out rows to keep - the way to do this thresholding should probably be tweaked</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_all</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Choosing which measured data to keep...&#39;</span><span class="p">)</span>
            <span class="n">other_ecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ec</span> <span class="k">for</span> <span class="n">ec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ec</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="p">]</span>
            <span class="n">obs_data_grps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">other_ecs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">obs_data_grps</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">subset</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">obs_data_grps</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">grp</span><span class="p">]])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;max_ec_x_step&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">max_step</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;max_ec_x_step&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">max_step</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="p">]</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using </span><span class="si">%.2f</span><span class="s1"> as the maximum step size in </span><span class="si">%s</span><span class="s1"> when choosing observation points to keep at </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">max_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="p">,</span> <span class="n">other_ecs</span><span class="p">,</span> <span class="n">grp</span><span class="p">))</span>
                <span class="n">thresh</span> <span class="o">=</span> <span class="n">thresh_dif_frac</span> <span class="o">*</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">])</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">]))</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">this_pt</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">next_pt</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">next_pt</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="p">]</span><span class="o">-</span><span class="n">this_pt</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">max_step</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">next_pt</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">]</span><span class="o">-</span><span class="n">this_pt</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">:</span>
                        <span class="n">subset</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">next_pt</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">next_pt</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

        <span class="c1"># round EC values</span>
        <span class="n">rd_dct</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="n">c</span><span class="o">.</span><span class="n">tol_digits</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ecs</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rd_dct</span><span class="p">)</span>

        <span class="c1"># sort observed data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># populate list of EC points</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ecs</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># it&#39;s finicky in this case</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ec_pts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ec_pts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">())</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ec_pts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">())</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ec_pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec_pts</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">())</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.check_data_columns"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.check_data_columns">[docs]</a>    <span class="k">def</span> <span class="nf">check_data_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure the columns in imported data make sense.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_data (`DataFrame`): dataset to check</span>
<span class="sd">            output_column (`str`): optional, header of column containing output data (required if different from self.output_var)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_data</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;model_data&#39;</span><span class="p">]</span>
        <span class="n">output_col</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;output_column&#39;</span><span class="p">]</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="c1"># first, check that the output is there</span>
        <span class="k">if</span> <span class="n">output_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Your output variable name, </span><span class="si">%s</span><span class="s1">, is not the name of a column in your model data!&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">output_col</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output_col</span><span class="p">)</span>
            <span class="c1"># next, that all the experimental conditions are there</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Experimental condition </span><span class="si">%s</span><span class="s1"> is not the name of a column in your model data!&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="c1"># if param_names has been populated, check if they match</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">()</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">())</span><span class="o">==</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                    <span class="k">pass</span> <span class="c1"># all good</span>
                <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ignoring extra columns in model data file: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">())))))</span>
                <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">()):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;These experimental conditions were missing from your model data file: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Proceeding assuming that </span><span class="si">%s</span><span class="s1"> is the full set of experimental conditions...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">())</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">))),</span> <span class="nb">str</span><span class="p">(</span><span class="n">cols</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Determining fitting parameters from modeled data...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">==</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">model_data</span><span class="p">[</span><span class="n">c</span><span class="p">]))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add_fit_param</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">vals</span><span class="o">=</span><span class="n">vals</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found fitting parameters: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">())</span></div>

<div class="viewcode-block" id="Model.check_ecs"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.check_ecs">[docs]</a>    <span class="k">def</span> <span class="nf">check_ecs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that all experimental conditions are present at each parameter point in modeled data.</span>

<span class="sd">        Args:</span>
<span class="sd">            gb (:obj:`groupby`): Pandas groupby object of model data grouped by parameter points</span>
<span class="sd">            verbose (`bool`): flag for verbosity, defaults to False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking that modeled data contains all experimental conditions at every combination of fit parameters...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">grps</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;gb&#39;</span><span class="p">]</span>
        <span class="c1"># then check at each model point that they match</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">group</span> <span class="ow">in</span> <span class="n">grps</span><span class="p">:</span>
            <span class="c1">#print(self.ec_pts,group[self.ec_names()].sort_values(self.ec_names()).reset_index(drop=True))</span>
            <span class="c1"># specifically, we check that EC pts is a SUBSET of model EC&#39;s at each parameter space point</span>
            <span class="n">ec_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec_pts</span><span class="o">.</span><span class="n">index</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_pts</span><span class="o">==</span><span class="n">group</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">()]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">())</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ec_inds</span><span class="p">]):</span>
                <span class="c1"># FIX MEEEEE</span>
                <span class="c1">#raise ValueError(&#39;The experimental conditions do not match to %d digits between the observed and modeled data at the modeled parameter space point %s!&#39;%(self.ec_tol_digits,name))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;there is a problem I need to fix the error message for!&#39;</span><span class="p">)</span>
                <span class="k">return</span></div>

<div class="viewcode-block" id="Model.calc_indices"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.calc_indices">[docs]</a>    <span class="k">def</span> <span class="nf">calc_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute starting and ending indices in self.model_data for each point in self.probs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">end_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1">#print(list(self.model_data_grps.groups.keys())[:5])</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1">#print(tuple(pt[1][self.fit_param_names()].tolist()))</span>
            <span class="n">subset_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data_grps</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">()]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset_inds</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Something went wrong calculating sim indices! Could not find any points in model data for params </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="o">%</span><span class="n">pt</span><span class="p">)</span>
            <span class="n">start_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">subset_inds</span><span class="p">))</span>
            <span class="n">end_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">subset_inds</span><span class="p">))</span>
            <span class="n">start_indices</span><span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">start_ind</span>
            <span class="n">end_indices</span><span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">end_ind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;start_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;end_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_indices</span></div>

<div class="viewcode-block" id="Model.attach_model"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.attach_model">[docs]</a>    <span class="k">def</span> <span class="nf">attach_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attach the model for the data, either by feeding in a file of precomputed data or a function that does the computing.</span>

<span class="sd">        Args:</span>
<span class="sd">            mode (`str`): &#39;file&#39; or &#39;function&#39;</span>
<span class="sd">            model_data_func (callable): if mode=&#39;function&#39;, provide function here</span>
<span class="sd">            model_data_path (`str`): if mode==&#39;file&#39;, provide path to file</span>
<span class="sd">            output_column (`str`): optional, header of column containing output data (required if different from self.output_var)</span>
<span class="sd">            calc_model_unc (`bool`): whether to calculate model uncertainties as well, defaults to False</span>
<span class="sd">            verbose (`bool`): flag for verbosity, defaults to False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
        <span class="n">output_col</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_column&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">calc_model_unc</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;calc_model_unc&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Attaching simulated data...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
            <span class="c1"># import and sort data on parameter values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="s1">&#39;model_data_path&#39;</span><span class="p">])</span>

            <span class="c1"># Check that columns match EC&#39;s and parameter names</span>
            <span class="c1"># (and determine parameter names if need be)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_data_columns</span><span class="p">(</span><span class="n">model_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">,</span> <span class="n">output_column</span><span class="o">=</span><span class="n">output_col</span><span class="p">)</span>

            <span class="c1"># now sort data by param names and EC&#39;s</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">()</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">())</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># next get list of parameter space points</span>
            <span class="n">param_points_grps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">())</span>
            <span class="n">param_points</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">param_points_grps</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">())</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">())</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># if PMF has been populated, check that points match</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                <span class="c1">#print(len(param_points),len(self.probs.points[self.fit_param_names()]))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">param_points</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">()]):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Your previously populated PMF does not have the same set of parameter space points as your model data. Proceeding using the points from the model data.&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">()</span>

            <span class="c1">## check that all EC&#39;s are present at all model points</span>
            <span class="c1"># first get list of EC points from observed data (round off and sort values before comparison)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_ecs</span><span class="p">(</span><span class="n">gb</span><span class="o">=</span><span class="n">param_points_grps</span><span class="p">)</span>

            <span class="c1"># Generate self.probs if necessary</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">is_empty</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Initializing probability distribution...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># check that points are on a grid (the quick but slightly less certain way)</span>
                <span class="n">param_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">param_points</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">()]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">param_lengths</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">param_points</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Your modeled parameter space does not appear to be on a grid; the current version of bayesim can only handle initially gridded spaces (unless using a previously saved subdivided state).&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;function&#39;</span><span class="p">:</span>
            <span class="c1"># is there a way to save this (that could be saved to HDF5 too) so that subdivide can automatically call it?</span>
            <span class="n">model_func</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;model_data_func&#39;</span><span class="p">]</span>

            <span class="c1"># check that probs.points is populated...</span>


            <span class="c1"># iterate over parameter space and measured conditions to compute output at every point</span>
            <span class="n">param_vecs</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">()}</span>
            <span class="n">ec_vecs</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">()}</span>
            <span class="n">model_vals</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">param_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">()}</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">ec_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">()}</span>
                    <span class="c1"># add param and EC vals to the columns</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">():</span>
                        <span class="n">param_vecs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_vals</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">():</span>
                        <span class="n">ec_vecs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">c</span><span class="p">])</span>
                    <span class="c1"># compute/look up the model data</span>
                    <span class="c1"># need to make sure that model_func takes in params and EC in appropriate format</span>
                    <span class="n">model_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_func</span><span class="p">(</span><span class="n">ec_vals</span><span class="p">,</span><span class="n">param_vals</span><span class="p">))</span>

            <span class="c1"># merge dictionaries together to put into a model data df</span>
            <span class="n">vecs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">param_vecs</span><span class="p">)</span>
            <span class="n">vecs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ec_vecs</span><span class="p">)</span>
            <span class="n">vecs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">:</span><span class="n">model_vals</span><span class="p">})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">vecs</span><span class="p">)</span>

        <span class="c1"># reset index to avoid duplication</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#print(&#39;before rounding&#39;)</span>
        <span class="c1">#print(self.model_data.head())</span>

        <span class="c1"># round EC&#39;s and generate groups</span>
        <span class="n">rd_dct</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="n">c</span><span class="o">.</span><span class="n">tol_digits</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ecs</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rd_dct</span><span class="p">)</span>

        <span class="c1"># round fit params - actually just force them to be members of the vals lists</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rounding model data...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">get_closest_val</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]]</span>

        <span class="c1"># generate groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_data_ecgrps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_data_grps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">())</span>

        <span class="c1">#print(&#39;before index calc&#39;)</span>
        <span class="c1">#print(self.model_data.head())</span>

        <span class="c1"># update flag and indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needs_new_model_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_indices</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">calc_model_unc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_model_unc</span><span class="p">(</span><span class="o">**</span><span class="n">argv</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.comparison_plot"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.comparison_plot">[docs]</a>    <span class="k">def</span> <span class="nf">comparison_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot observed data vs. highest-probability modeled data.</span>

<span class="sd">        Args:</span>
<span class="sd">            ec_vals (`dict`): optional, dict of EC values at which to plot. If not provided, they will be chosen randomly. This can also be a list of dicts for multiple points.</span>
<span class="sd">            num_ecs (`int`): number of EC values to plot, defaults to 1 (ignored if ecs is provided)</span>
<span class="sd">            num_param_pts (`int`): number of the most probable parameter space points to plot (defaults to 1)</span>
<span class="sd">            ec_x_var (`str`): one of self.ec_names, will overwrite if this was provided before in attach_observations, required if it wasn&#39;t. If ec was provided, this will supercede that</span>
<span class="sd">            fpath (`str`): optional, path to save image to if desired</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;ec_x_var&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">set_ec_x</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="s1">&#39;ec_x_var&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You have not provided an x-variable from your experimental conditions against which to plot. Choosing the first one in the list, </span><span class="si">%s</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">set_ec_x</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">other_ecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ecs</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="p">]</span>
        <span class="c1">#print(self.params.ec_x_name, [c.name for c in other_ecs])</span>

        <span class="c1"># read in options and do some sanity checks</span>
        <span class="n">num_ecs</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_ecs&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_ecs</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1">#only one experimental condition...</span>
            <span class="n">one_ec</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ec_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#placeholder, basically - this is klunky</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># more than one</span>
            <span class="n">one_ec</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;ec_vals&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ec_vals</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;ec_vals&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ec_vals</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ec_vals</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                    <span class="n">ec_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">ec_vals</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ec_vals</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ec_pts</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">other_ecs</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">num_ecs</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">ec_pts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_ecs</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1">#pt will just be a float rather than a tuple</span>
                        <span class="n">ec_vals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">other_ecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="n">pt</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ec_vals</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">other_ecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pt</span><span class="p">))})</span>

        <span class="n">num_param_pts</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_param_pts&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># need to fix this check</span>
        <span class="c1">#if self.params.ec_x_name in ecs.keys():</span>
            <span class="c1">#print(&#39;You provided a fixed value for your x variable, ignoring that and plotting the full range.&#39;)</span>
            <span class="c1">#del ecs[self.params.ec_x_name]</span>

        <span class="c1"># get parameter points for which to plot data</span>
        <span class="n">param_pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">most_probable</span><span class="p">(</span><span class="n">num_param_pts</span><span class="p">)</span>

        <span class="c1"># set up subplots</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ec_vals</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="mi">4</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">ec_vals</span><span class="p">)),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># get color cycle</span>
        <span class="n">prop_cycle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.prop_cycle&#39;</span><span class="p">]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">prop_cycle</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>

        <span class="c1"># at each set of conditions...</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ec_vals</span><span class="p">)):</span>
            <span class="n">obs_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span>
            <span class="n">plot_title</span> <span class="o">=</span> <span class="s1">&#39;Comparison  &#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">one_ec</span><span class="p">:</span>
                <span class="n">plot_title</span> <span class="o">=</span> <span class="n">plot_title</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;at &#39;</span>
                <span class="n">ecs_here</span> <span class="o">=</span> <span class="n">ec_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># get obs data for correct EC values</span>
                <span class="c1">#print(ecs_here, obs_data.head())</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">other_ecs</span><span class="p">:</span>
                    <span class="n">obs_data</span> <span class="o">=</span>  <span class="n">obs_data</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">obs_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">-</span><span class="n">ecs_here</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">])</span><span class="o">&lt;=</span><span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">tol_digits</span><span class="p">)]</span>
                    <span class="n">plot_title</span> <span class="o">=</span> <span class="n">plot_title</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">, &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">get_val_str</span><span class="p">(</span><span class="n">ecs_here</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
            <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="p">])</span>
            <span class="c1"># plot obs data</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="p">],</span> <span class="n">obs_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">legend_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;observed&#39;</span><span class="p">]</span>
            <span class="n">c_ind</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># plot modeled data and errors</span>
            <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">param_pts</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">c_ind</span><span class="p">]</span>
                <span class="n">model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data_grps</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">()])]]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">one_ec</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">other_ecs</span><span class="p">:</span>
                        <span class="n">model_data</span> <span class="o">=</span>  <span class="n">model_data</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">model_data</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">-</span><span class="n">ecs_here</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">])</span><span class="o">&lt;=</span><span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">tol_digits</span><span class="p">)]</span>
                <span class="n">model_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="p">])</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">model_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">],</span> <span class="n">obs_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">])</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="p">],</span> <span class="n">model_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ec_x_name</span><span class="p">],</span> <span class="n">errors</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="n">leg_label</span> <span class="o">=</span> <span class="s1">&#39;modeled: &#39;</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">:</span>
                    <span class="n">leg_label</span> <span class="o">=</span> <span class="n">leg_label</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">, &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">get_val_str</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
                <span class="n">leg_label</span> <span class="o">=</span> <span class="n">leg_label</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">legend_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leg_label</span><span class="p">)</span>
                <span class="n">c_ind</span> <span class="o">=</span> <span class="n">c_ind</span><span class="o">+</span><span class="mi">1</span>

            <span class="c1"># set ylims to match observed data and label axes</span>
            <span class="n">obs_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">obs_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">])</span>
            <span class="n">obs_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">obs_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">])</span>
            <span class="n">obs_width</span> <span class="o">=</span> <span class="n">obs_max</span><span class="o">-</span><span class="n">obs_min</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">obs_min</span><span class="o">-</span><span class="mf">0.05</span><span class="o">*</span><span class="n">obs_width</span><span class="p">,</span> <span class="n">obs_max</span><span class="o">+</span><span class="mf">0.05</span><span class="o">*</span><span class="n">obs_width</span><span class="p">])</span>
            <span class="n">xvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get_ec_x</span><span class="p">()</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">xvar</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">xvar</span><span class="o">.</span><span class="n">units</span><span class="p">))</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">xvar</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">xvar</span><span class="o">.</span><span class="n">units</span><span class="p">))</span>
            <span class="n">yvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">find_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">yvar</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">yvar</span><span class="o">.</span><span class="n">units</span><span class="p">))</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span><span class="p">(</span><span class="s1">&#39;$\Delta$&#39;</span><span class="o">+</span><span class="n">yvar</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">yvar</span><span class="o">.</span><span class="n">units</span><span class="p">))</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend_list</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">plot_title</span> <span class="o">=</span> <span class="n">plot_title</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">one_ec</span><span class="p">:</span>
                <span class="n">err_title</span> <span class="o">=</span> <span class="s1">&#39;Errors&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err_title</span> <span class="o">=</span> <span class="n">plot_title</span> <span class="o">+</span> <span class="s1">&#39;: errors&#39;</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">err_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">([</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">+</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span> <span class="o">+</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;fpath&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="s1">&#39;fpath&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Model.run"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do Bayes!</span>
<span class="sd">        Will stop iterating through observations if/when &gt;= th_pm of probability mass is concentrated in &lt;= th_pv of boxes and decide it&#39;s time to subdivide. (completely arbitrary thresholding for now)</span>

<span class="sd">        Args:</span>
<span class="sd">            save_step (`int`): interval (number of data points) at which to save intermediate PMF&#39;s (defaults to 10, 0 to save only final, &lt;0 to save none)</span>
<span class="sd">            th_pm (`float`): threshold quantity of probability mass to be concentrated in th_pv fraction of parameter space to trigger the run to stop (defaults to 0.9)</span>
<span class="sd">            th_pv (`float`): threshold fraction of parameter space volume for th_pm fraction of probability to be concentrated into to trigger the run to stop (defaults to 0.05)</span>
<span class="sd">            min_num_pts (`int`): minimum number of observation points to use - if threshold is reached before this number of points has been used, it will start over and the final PMF will be the average of the number of runs needed to use sufficient points (defaults to 0.7 * the number of experimental measurements)</span>
<span class="sd">            prob_bias (`float`): number from 0 to 0.5, fraction of PMF from previous step to mix into prior for this step (defaults to 0) - higher values will likely converge faster but possibly have larger errors, especially if min_num_pts is small</span>
<span class="sd">            verbose (`bool`): flag for verbosity, defaults to False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># read in options</span>
        <span class="n">save_step</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_step&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">th_pm</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;th_pm&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
        <span class="n">th_pv</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;th_pv&#39;</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">min_num_pts</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_num_pts&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.7</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="p">)))</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">bias</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prob_bias&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bias</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">bias</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bias parameter must be between 0 and 0.5 - defaulting to 0.&quot;</span><span class="p">)</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running inference!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">min_num_pts</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot use more observation points than there are in the data. Setting min_num_pts to len(self.obs_data)=</span><span class="si">%d</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="p">))</span>
            <span class="n">min_num_pts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="p">)</span>

        <span class="c1"># do some sanity checks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_new_model_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Oops, you need to attach model data before running!&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_run</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running again at the same subdivision level. Previous results may be overridden...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># set up folders for intermediate files</span>
        <span class="k">if</span> <span class="n">save_step</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">pmf_folder</span> <span class="o">=</span> <span class="n">folder</span><span class="o">+</span><span class="s1">&#39;/PMFs/&#39;</span>
            <span class="n">obs_list_folder</span> <span class="o">=</span> <span class="n">folder</span><span class="o">+</span><span class="s1">&#39;/obs_lists/&#39;</span>
            <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pmf_folder</span><span class="p">,</span><span class="n">obs_list_folder</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

        <span class="c1"># rather than uniformizing, averaging the previous probs with a quasi-uniform</span>
        <span class="n">old_probs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">)</span>
        <span class="n">uni_probs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">)</span>
        <span class="n">uni_probs</span><span class="o">.</span><span class="n">uniformize</span><span class="p">()</span>
        <span class="n">start_probs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">)</span>
        <span class="n">start_probs</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bias</span><span class="o">*</span><span class="n">old_probs</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">bias</span><span class="p">)</span><span class="o">*</span><span class="n">uni_probs</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span>
        <span class="n">start_probs</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>

        <span class="c1"># randomize observation order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">num_pts_used</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_runs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">probs_lists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">delta_count_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nan_count_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">num_pts_used</span> <span class="o">&lt;</span> <span class="n">min_num_pts</span><span class="p">:</span>
            <span class="n">prev_used_pts</span> <span class="o">=</span> <span class="n">num_pts_used</span>
            <span class="n">num_runs</span> <span class="o">=</span> <span class="n">num_runs</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">obs_indices</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="n">start_probs</span>

            <span class="n">done</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                <span class="c1"># check if we&#39;ve gone through all the points</span>
                <span class="k">if</span> <span class="n">num_pts_used</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Used all the observed data! Last PMF to go into average may have been further from threshold condition.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># get observed and modeled data</span>
                    <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">num_pts_used</span><span class="p">]</span>
                    <span class="n">obs_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_pts_used</span><span class="p">)</span>
                    <span class="n">ec</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">()]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">())</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">ecpt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">ec</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">()])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ecpt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ec</span><span class="p">)</span>
                    <span class="c1">#print(ecpt)</span>
                    <span class="c1">#print(self.model_data_ecgrps.groups.keys())</span>
                    <span class="n">model_here</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data_ecgrps</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">ecpt</span><span class="p">]])</span>

                    <span class="c1"># compute likelihood and do a Bayesian update</span>
                    <span class="n">lkl</span><span class="p">,</span> <span class="n">delta_count</span><span class="p">,</span> <span class="n">nan_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">likelihood</span><span class="p">(</span><span class="n">meas</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span> <span class="n">model_at_ec</span><span class="o">=</span><span class="n">model_here</span><span class="p">,</span><span class="n">output_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">lkl</span><span class="p">)</span>
                    <span class="n">num_pts_used</span> <span class="o">=</span> <span class="n">num_pts_used</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">delta_count_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delta_count</span><span class="p">)</span>
                    <span class="n">nan_count_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nan_count</span><span class="p">)</span>

                    <span class="c1"># save intermediate PMF if necessary</span>
                    <span class="k">if</span> <span class="n">save_step</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">num_pts_used</span><span class="o">-</span><span class="n">prev_used_pts</span><span class="p">)</span> <span class="o">%</span> <span class="n">save_step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pmf_folder</span><span class="o">+</span><span class="s1">&#39;sub</span><span class="si">%d</span><span class="s1">_run</span><span class="si">%d</span><span class="s1">_PMF_</span><span class="si">%d</span><span class="s1">.h5&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">num_sub</span><span class="p">,</span><span class="n">num_runs</span><span class="p">,</span><span class="n">num_pts_used</span><span class="o">-</span><span class="n">prev_used_pts</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>

                    <span class="c1"># check if threshold probability concentration has been reached</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">most_probable</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">th_pv</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">)))[</span><span class="s1">&#39;prob&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="n">th_pm</span><span class="p">:</span>
                        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                    <span class="n">probs_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">save_step</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pmf_folder</span><span class="o">+</span><span class="s1">&#39;sub</span><span class="si">%d</span><span class="s1">_run</span><span class="si">%d</span><span class="s1">_PMF_final.h5&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">num_sub</span><span class="p">,</span><span class="n">num_runs</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>
                    <span class="n">at_threshold</span><span class="o">=</span><span class="kc">True</span>
                    <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">obs_list_folder</span><span class="o">+</span><span class="s1">&#39;sub</span><span class="si">%d</span><span class="s1">_run</span><span class="si">%d</span><span class="s1">_obs_list.h5&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">num_sub</span><span class="p">,</span><span class="n">num_runs</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">obs_indices</span><span class="p">])</span>

        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">probs_lists</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Did a total of </span><span class="si">%d</span><span class="s1"> runs to use a total of </span><span class="si">%d</span><span class="s1"> observations.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">num_runs</span><span class="p">,</span><span class="n">num_pts_used</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">An average of </span><span class="si">%d</span><span class="s1"> / </span><span class="si">%d</span><span class="s1"> probability points had larger model uncertainty than experimental uncertainty during this run.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">delta_count_list</span><span class="p">))),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">)))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">An average of </span><span class="si">%.2f</span><span class="s1"> / </span><span class="si">%d</span><span class="s1"> probability points were affected by missing/NaN simulation data.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">nan_count_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">save_step</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pmf_folder</span><span class="o">+</span><span class="s1">&#39;sub</span><span class="si">%d</span><span class="s1">_PMF_final.h5&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">num_sub</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_run</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Model.subdivide"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.subdivide">[docs]</a>    <span class="k">def</span> <span class="nf">subdivide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subdivide the probability distribution and save the list of new sims to run to a file.</span>

<span class="sd">        Args:</span>
<span class="sd">            threshold_prob (`float`): minimum probability of box to (keep and) subdivide (default 0.001)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">threshold_prob</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;threshold_prob&#39;</span><span class="p">,</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">new_boxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">subdivide</span><span class="p">(</span><span class="n">threshold_prob</span><span class="p">)</span>
        <span class="c1">#dropped_inds = list(dropped_boxes.index)</span>

        <span class="c1">#self.fit_params = [p for p in self.probs.params]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attach_fit_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># remove old model data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># update flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needs_new_model_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_run</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#dd.io.save(filename,new_boxes)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;new_sim_points_</span><span class="si">%d</span><span class="s1">.h5&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">num_sub</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_model_pts_to_run</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New model points to simulate are saved in the file </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="o">%</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.list_model_pts_to_run"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.list_model_pts_to_run">[docs]</a>    <span class="k">def</span> <span class="nf">list_model_pts_to_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate full list of model points that need to be run (not just parameter points but also all experimental conditions). Saves to HDF5 at fpath.</span>

<span class="sd">        Note that this could be very slow if used on the initial grid (i.e. for potentially millions of points) - it&#39;s better for after a subdivide call.</span>

<span class="sd">        Args:</span>
<span class="sd">            fpath (`str`): path to save the list to (HDF5)</span>
<span class="sd">            verbose (`bool`): flag for verbosity, defaults to False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Listing the sets of simulation parameters that need to be run...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># get just the columns with the parameters</span>
        <span class="n">param_pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">()]</span>

        <span class="c1"># Now at every point in that list, make a row for every EC point</span>
        <span class="n">param_inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_pts</span><span class="p">))</span>
        <span class="n">ec_inds</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec_pts</span><span class="p">))</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec_names</span><span class="p">()</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ppt</span> <span class="ow">in</span> <span class="n">param_pts</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">ecpt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec_pts</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ppt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">ecpt</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">sim_pts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pts</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span><span class="n">sim_pts</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.calc_model_unc"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.calc_model_unc">[docs]</a>    <span class="k">def</span> <span class="nf">calc_model_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates largest difference in modeled output along any parameter direction for each experimental condition, to be used for uncertainty in calculating likelihoods. Currently only works if data is on a grid.</span>

<span class="sd">        (also assumes it&#39;s sorted by param names and then EC&#39;s)</span>

<span class="sd">        Args:</span>
<span class="sd">            verbose (`bool`): flag for verbosity, defaults to False</span>
<span class="sd">            model_unc_factor (`float`): multiplier on deltas to give uncertainty, defaults to 0.5 - smaller probably means faster convergence, but also higher chance to miss &quot;hot spots&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">factor</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_unc_factor&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">argv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating model uncertainty...&#39;</span><span class="p">)</span>

        <span class="n">param_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">length</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">]</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">))</span>

        <span class="c1"># for every set of conditions...</span>
        <span class="n">deltas_list</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">cpu_count</span><span class="p">())(</span><span class="n">delayed</span><span class="p">(</span><span class="n">calc_deltas</span><span class="p">)(</span><span class="n">grp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data_ecgrps</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">grp</span><span class="p">],</span> <span class="n">param_lengths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_param_names</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_var</span><span class="p">)</span> <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data_ecgrps</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">deltas_list</span><span class="p">:</span>
            <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data_ecgrps</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">deltas</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># trying 0.5 instead of 1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">deltas</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating model uncertainty took </span><span class="si">%.2f</span><span class="s1"> seconds.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">))</span></div>

<div class="viewcode-block" id="Model.save_state"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.save_state">[docs]</a>    <span class="k">def</span> <span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;bayesim_state.h5&#39;</span><span class="p">):</span> <span class="c1">#rewrite this!</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the entire state of this model object to an HDF5 file so that work can be resumed later.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># construct a dict with all the state variables</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># parameters</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;ec_pts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec_pts</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;output_var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_var</span>

        <span class="c1"># PMF</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;probs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="c1"># model/data</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;model_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;model_data_grps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data_grps</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;model_data_ecgrps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_data_ecgrps</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;needs_new_model_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_new_model_data</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;obs_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obs_data</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;is_run&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_run</span>

        <span class="c1"># save the file</span>
        <span class="n">dd</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">state</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.visualize_grid"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.visualize_grid">[docs]</a>    <span class="k">def</span> <span class="nf">visualize_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualize the current state of the grid.</span>

<span class="sd">        Args:</span>
<span class="sd">            same as pmf.visualize()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">just_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">argv</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.visualize_probs"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.visualize_probs">[docs]</a>    <span class="k">def</span> <span class="nf">visualize_probs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualize the PMF with a corner plot.</span>

<span class="sd">        Args:</span>
<span class="sd">            same as pmf.visualize()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="o">**</span><span class="n">argv</span><span class="p">)</span></div>

<span class="c1"># maybe I&#39;ll finish this eventually</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    def visualize_model_unc(self,**argv):</span>

<span class="sd">        #Visualize model uncertainty.</span>

<span class="sd">        #Args:</span>
<span class="sd">        #    ec_vals (`dict`): optional, dict of EC values at which to plot. If not provided, they will be chosen randomly. This can also be a list of dicts for multiple points.</span>
<span class="sd">        #    num_ecs (`int`): number of EC values to plot, defaults to 1 (ignored if ecs is provided)</span>

<span class="sd">        # read in options and do some sanity checks</span>
<span class="sd">        num_ecs = argv.get(&#39;num_ecs&#39;,1)</span>
<span class="sd">        if &#39;ec_vals&#39; in argv.keys():</span>
<span class="sd">            ec_vals = argv[&#39;ec_vals&#39;]</span>
<span class="sd">            if not (isinstance(ec_vals,list) or isinstance(ec_vals,np.ndarray)):</span>
<span class="sd">                ec_vals = [ec_vals]</span>
<span class="sd">        else:</span>
<span class="sd">            ec_vals = []</span>
<span class="sd">            ec_pts_df = self.ec_pts.sample(num_ecs)</span>
<span class="sd">            ec_pts=[]</span>
<span class="sd">            for pt in ec_pts_df.iterrows():</span>
<span class="sd">                ec_vals.append({name:pt[1][name] for name in self.ec_names()})</span>
<span class="sd">                ec_pts.append(tuple(pt[1][self.ec_names()]))</span>

<span class="sd">        # set up subplots</span>
<span class="sd">        fig, axs = plt.subplots(len(ec_vals), figsize=(13,4*len(ec_vals)), squeeze=False)</span>

<span class="sd">        for i in range(len(ec_vals)):</span>
<span class="sd">            ecs_here = ec_vals[i]</span>
<span class="sd">            plot_title = &#39;&#39;</span>
<span class="sd">            for c in self.params.ecs:</span>
<span class="sd">                plot_title = plot_title + &#39;%s=%s, &#39;%(c.name,c.get_val_str(ecs_here[c.name]))</span>
<span class="sd">            subset = self.model_data.loc[self.model_data_ecgrps[tuple([ecs_here[n] for n in self.ec_names()])]]</span>
<span class="sd">            dense_grid = probs.populate_dense_grid(df=subset, col_to_pull=&#39;uncerainty&#39;, make_ind_lists=False)</span>
<span class="sd">            mat = dense_grid[&#39;mat&#39;]</span>
<span class="sd">            axs[i].imshow(mat)</span>
<span class="sd">            axs[i].set_title(plot_title)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Model.top_probs"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.top_probs">[docs]</a>    <span class="k">def</span> <span class="nf">top_probs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a DataFrame with the &#39;num&#39; most probable points and some of the less interesting columns hidden.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">most_probable</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="p">[[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_min&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_max&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span></div>

<div class="viewcode-block" id="Model.set_param_info"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.set_param_info">[docs]</a>    <span class="k">def</span> <span class="nf">set_param_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="o">**</span><span class="n">argv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set additional info for parameter param_name (any type).</span>

<span class="sd">        Args:</span>
<span class="sd">            param_name (str): name of parameter to modify</span>
<span class="sd">            units (str): units of parameter</span>
<span class="sd">            min_width (float): minimum width of parameter (only for fitting params)</span>
<span class="sd">            display_name (str): name to use on plots (can include TeX)</span>
<span class="sd">            tolerance (float): tolerance for this parameter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">all_params</span><span class="p">()],</span> <span class="s2">&quot;I can&#39;t set info for a parameter (</span><span class="si">%s</span><span class="s2">) that doesn&#39;t exist!&quot;</span><span class="o">%</span><span class="n">param_name</span>

        <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">param_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ecs</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">param_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">param_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;min_width&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">param_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">min_width</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;min_width&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;display_name&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">param_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fit_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ecs</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">param_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ecs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">param_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span>

        <span class="c1"># pass these through to PMF since it doesn&#39;t always seem to happen automatically...</span>
        <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">param_names</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">params</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">param_name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;min_width&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">min_width</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;min_width&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;display_name&#39;</span> <span class="ow">in</span> <span class="n">argv</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Model.ec_names"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.ec_names">[docs]</a>    <span class="k">def</span> <span class="nf">ec_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of experimental condition names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">param_names</span><span class="p">(</span><span class="s1">&#39;ec&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.fit_param_names"><a class="viewcode-back" href="../../source/bayesim.html#bayesim.model.Model.fit_param_names">[docs]</a>    <span class="k">def</span> <span class="nf">fit_param_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of fitting parameter names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">param_names</span><span class="p">(</span><span class="s1">&#39;fit&#39;</span><span class="p">)</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2018, Rachel C Kurchin and Giuseppe Romano.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>